# Inferencia causal

Responder a preguntas causales es crucial para fines cient√≠ficos, pero t√©cnicas como ensayos cl√≠nicos aleatorios no siempre son posibles de realizar. Las herramientas que aprender√°s con este libro te permitir√°n realizar inferencias causales con mayor eficacia a partir de datos observacionales utilizando el lenguaje de programaci√≥n R.

```{r echo =FALSE}
library(ggplot2)
library(showtext)

options(
  # set default colors in ggplot2 to colorblind-friendly
  # Okabe-Ito and Viridis palettes
  ggplot2.discrete.colour = ggokabeito::palette_okabe_ito(),
  ggplot2.discrete.fill = ggokabeito::palette_okabe_ito(),
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis",
  # set theme font and size
  book.base_family = "sans",
  book.base_size = 14
)

library(ggplot2)

# set default theme
theme_set(
  theme_minimal(
    base_size = getOption("book.base_size"),
    base_family = getOption("book.base_family")
  ) %+replace%
    theme(
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
)

theme_dag <- function() {
  ggdag::theme_dag(base_family = getOption("book.base_family"))
}

geom_dag_label_repel <- function(..., seed = 10) {
  ggdag::geom_dag_label_repel(
    aes(x, y, label = label),
    box.padding = 3.5,
    inherit.aes = FALSE,
    max.overlaps = Inf,
    family = getOption("book.base_family"),
    seed = seed,
    label.size = NA,
    label.padding = 0.1,
    size = getOption("book.base_size") / 3,
    ...
  )
}

```

# Modelos causales

## Criterios de hill

A menudo se hace referencia a los criterios de Hill como la definici√≥n est√°ndar de causalidad en epidemiolog√≠a (con casi 10 000 citas). Hill propone 9 criterios, utilizando el ejemplo de la evaluaci√≥n de la causalidad entre la exposici√≥n al tabaquismo y el c√°ncer de pulm√≥n.

1.  Asociaci√≥n fuerte : ¬øLa exposici√≥n est√° asociada con un efecto importante en el empeoramiento del resultado?

2.  Consistencia : ¬øSe han repetido los hallazgos del estudio en diferentes circunstancias?

3.  Especificidad : ¬øSe puede vincular la exposici√≥n a una enfermedad o causa espec√≠fica de mortalidad?

4.  Temporalidad : ¬øSe mide la exposici√≥n antes de la incidencia del resultado?

5.  Gradiente biol√≥gico : ¬øExiste una relaci√≥n dosis-respuesta entre la exposici√≥n y la gravedad de la enfermedad?

6.  Plausibilidad : ¬øEs biol√≥gicamente plausible una relaci√≥n causal?

7.  Coherencia : ¬øLa relaci√≥n causal hipot√©tica es coherente con el conocimiento existente?

8.  Experimentaci√≥n : ¬øSe puede verificar la relaci√≥n causal mediante experimentaci√≥n?

9.  Analog√≠a : ¬øPodemos definir una analog√≠a entre el efecto hipot√©tico y otra relaci√≥n causal aceptada?

Los criterios de Hill representan un conjunto de consideraciones pero no proporcionan una definici√≥n replicable de causalidad para diferentes escenarios. Esta cuesti√≥n da motiv√≥ a que otros marcos concepturales pretendan explicar mejor que es la causalidad.

## El marco de desenlaces potenciales - modelo de Rubin

Se basa en la idea de comparar los resultados observados con los resultados que habr√≠an ocurrido si se hubieran tomado diferentes acciones o si las condiciones hubieran sido diferentes. Estos resultados alternativos, que no se observan directamente en los datos, se conocen como resultados contrafactuales.

El concepto de resultados contrafactuales es fundamental para entender el efecto causal de una intervenci√≥n o tratamiento. Implica imaginar qu√© habr√≠a pasado con un individuo o grupo si hubieran sido expuestos a una condici√≥n diferente o a un tratamiento alternativo. Esta comparaci√≥n entre lo que ocurri√≥ y lo que podr√≠a haber ocurrido bajo diferentes circunstancias permite estimar el efecto causal de una intervenci√≥n y entender su impacto en los resultados observados.

```{r, echo=FALSE}
knitr::include_graphics("fig/contrafactual.png")
```

Ver m√°s abajo (ser√° uno de nuestros enfoques principales)

## Gr√°ficos ac√≠clicos dirigidos (DAGs)

Modelo causal de Judea Perl - DAGs

Estos gr√°ficos representan relaciones causales entre variables mediante flechas direccionales, donde una flecha apunta desde la variable que se considera la causa hacia la variable que se considera el efecto. La caracter√≠stica fundamental de un DAG es que no contiene ciclos, lo que significa que no hay una secuencia de flechas que forme un bucle cerrado. Esto refleja la ausencia de relaciones causales circulares o retroalimentaci√≥n en el sistema representado (ya que esto incumpliria el supuesto de temporalidad).

Los DAG son √∫tiles para representar y visualizar hip√≥tesis causales y ayudan a los investigadores a identificar posibles relaciones causales entre variables y a entender la estructura causal subyacente en un conjunto de datos. Adem√°s, los DAG proporcionan un marco formal para especificar modelos causales y para derivar implicaciones de causalidad a partir de datos observacionales. Esto permite realizar inferencias causales s√≥lidas y evaluar el impacto de intervenciones potenciales en sistemas complejos.

```{r, echo=FALSE}
knitr::include_graphics("fig/DAG.png")
```

## Marco de Rothman

El modelo de causa de componentes suficientes de Rothman, postula un conjunto de mecanismos causales diferentes, cada uno de los cuales es suficiente para provocar el resultado que se est√° considerando. Rothman se refiere a estos mecanismos causales hipot√©ticos como ‚Äúcausas suficientes‚Äù, concibi√©ndolos como conjuntos m√≠nimos de acciones, eventos o estados de la naturaleza que juntos inician un proceso que da como resultado el desenlace.

Por lo tanto, se supone que cada causa suficiente consta de un conjunto de "causas componentes". Siempre que todos los componentes de una causa suficiente particular est√°n presentes, se produce el desenlace; as√≠, dentro de cada causa suficiente, cada componente ser√≠a necesario para que esa causa suficiente conduzca al desenlace.

En los modelos tradicionales de causa de componentes suficientes \[SCC\], el resultado y todas las causas componentes son eventos o, de manera equivalente, variables aleatorias binarias. Un modelo SCC con k causas componentes implica un conjunto de 2 k resultados potenciales. Por el contrario, en la secci√≥n 2 mostramos que para cualquier lista dada de resultados potenciales existe al menos un modelo SCC que representa este conjunto. Sin embargo, en general puede haber muchos modelos de SCC de este tipo.

```{r, echo=FALSE}
knitr::include_graphics("fig/rothman.jpg")
```

# ‚úÖModelo causal de Rubin - Resultados potenciales

El enfoque de Rubin, basado en el concepto de "potential outcomes" o resultados potenciales, se centra en estimar el efecto causal promedio de una intervenci√≥n mediante la comparaci√≥n de unidades tratadas y no tratadas. Por otro lado, el enfoque de Pearl, basado en la teor√≠a de grafos causales, utiliza diagramas causales para representar y analizar las relaciones causales entre variables, permitiendo la identificaci√≥n de caminos causales y la realizaci√≥n de inferencias causales m√°s detalladas.

En la mayor√≠a de cursos dan poca importancia a los resultados potenciales, en gran parte porque la idea de inferencia causal a trav√©s de DAGs (Modelo causal de Judea Perl) es m√°s simple.

El enfoque de resultados potenciales es incre√≠blemente popular y est√° muy extendido en las ciencias sociales (particularmente en econom√≠a), mientras que los modelos causales y los DAG son m√°s populares en campos como la epidemiolog√≠a. Por razones insondables, existe una extra√±a animosidad entre estos dos mundos. Judea Pearl critica regularmente a los cient√≠ficos sociales en Twitter por no utilizar DAG y aferrarse a resultados potenciales, mientras que los econometristas ganadores del Nobel condenan los DAG. Es raro y gracioso.

Esta visi√≥n de la causalidad sostiene que para cualquier tipo de intervenci√≥n (aprobar una nueva pol√≠tica, participar en un programa sin fines de lucro, tomar un tipo espec√≠fico de medicamento, etc.), las personas tendr√°n uno de dos resultados posibles:

1.  ¬øQu√© pasar√≠a si reciben la intervenci√≥n o tratamiento?, y

2.  ¬øQu√© pasar√≠a si no reciben el tratamiento?

Estos dos resultados son resultados potenciales. Ambos son plausibles, pero s√≥lo uno suceder√° en la vida real y el otro resultado suceder√° en un mundo contrafactual (mundo que solo podr√°s acceder con una maquina del tiempo o viajando en el multiverso de la locura). Estos resultados potenciales conducen a un conjunto de estimaciones causales diferentes que podr√≠an interesarnos, como el efecto promedio del tratamiento.

M√°s all√° de introducir la idea de que no podemos encontrar efectos causales a nivel individual sin una m√°quina del tiempo, pensar en resultados potenciales es interesante y podr√≠a resultar muy √∫til para estimar efectos causales.

```{r echo=FALSE}
library(tidyverse)
library(ggtext)
library(ggdag)
library(dagitty)
library(gt)
library(broom)
library(marginaleffects)
library(WeightIt)

# Define a nice color palette from {MoMAColors}
# https://github.com/BlakeRMills/MoMAColors
clrs <- MoMAColors::moma.colors("ustwo")

# Download Mulish from https://fonts.google.com/specimen/Mulish

theme_nice <- function() {
  theme_minimal() +
    theme(
      panel.grid.minor = element_blank(),
      plot.background = element_rect(fill = "white", color = NA),
      plot.title = element_text(face = "bold"),
      axis.title = element_text(face = "bold"),
      strip.text = element_text(face = "bold"),
      strip.background = element_rect(fill = "grey80", color = NA),
      legend.title = element_text(face = "bold")
    )
}

theme_set(theme_nice())

update_geom_defaults("text", list(fontface = "plain"))
update_geom_defaults("label", list(fontface = "plain"))
update_geom_defaults(ggdag:::GeomDagText, list( fontface = "plain"))
update_geom_defaults(ggtext::GeomRichText, list(fontface = "plain"))
```

Antes de entrar en las sutiles diferencias entre los distintos tipos de estimaciones relacionados con los resultados potenciales, es √∫til tener una idea general de c√≥mo funcionan estas cosas. As√≠ que vamos a introducrinos de forma progresiva sobre el marco de los resultados potenciales.

Todos los libros sobre inferencia causal incluyen una tabla como $Tabla 1$ para ilustrar los resultados potenciales. Para hacer esta idea un poco m√°s matem√°tica, llamaremos al tratamiento o intervenci√≥n $X$, al resultado que ocurrir√≠a si se tratara $Y^1$, y al resultado que ocurrir√≠a si no se tratara $Y^0$. Utilizaremos $\delta$ para la diferencia entre $Y^1$ y $Y^0$, o el efecto causal a nivel individual.

```{r echo =FALSE}
#| label: tbl-basic-po
#| tbl-cap: "Standard table showing potential outcomes, individual causal effects, and realized outcomes"
#| code-fold: true
#| classes: no-stripe

basic_po <- tribble(
  ~id, ~age,    ~treated, ~outcome_1, ~outcome_0,
  1,   "Old",   1,        80,         60,
  2,   "Old",   1,        75,         70,
  3,   "Old",   1,        85,         80,
  4,   "Old",   0,        70,         60,
  5,   "Young", 1,        75,         70,
  6,   "Young", 0,        80,         80,
  7,   "Young", 0,        90,         100,
  8,   "Young", 0,        85,         80
) |> 
  mutate(
    ite = outcome_1 - outcome_0,
    outcome = ifelse(treated == 1, outcome_1, outcome_0)
  )

basic_po |> 
  select(
    id, age, treated, outcome_1, outcome_0, ite, outcome
  ) |> 
  gt() |> 
  sub_missing(missing_text = "‚Ä¶") |>
  fmt_number(
    columns = c(starts_with("outcome"), ite),
    decimals = 0
  ) |> 

  # Column labels
  cols_label(
    id = "ID",
    age = md("$Z_i$"),
    treated = md("$X_i$"),
    outcome_0 = md("$Y^0_i$"),
    outcome_1 = md("$Y^1_i$"),
    outcome = md("$Y_i$"),
    ite = md("$Y^1_i - Y^0_i$")
  ) |>
  
  # Level 1 spanner labels
  tab_spanner(
    label = "Age", columns = age, 
    level = 1, id = "level1_a_po"
  ) |> 
  tab_spanner(
    label = "Treated", columns = treated, 
    level = 1, id = "level1_b_po"
  ) |> 
  tab_spanner(
    label = "Potential outcomes",
    columns = c(outcome_1, outcome_0),
    level = 1, id = "level1_c_po"
  ) |> 
  tab_spanner(
    label = "ITE or \\(\\delta_i\\)", columns = ite, 
    level = 1, id = "level1_d_po"
  ) |> 
  tab_spanner(
    label = "Outcome", columns = outcome, 
    level = 1, id = "level1_e_po"
  ) |> 
  
  # Level 2 spanner labels
  tab_spanner(
    label = "Confounder",
    columns = age,
    level = 2, id = "level2_a_po"
  ) |> 
  tab_spanner(
    label = "Treatment", columns = treated, 
    level = 2, id = "level2_b_po"
  ) |> 
  tab_spanner(
    label = "Unobservable",
    columns = c(outcome_1, outcome_0, ite), 
    level = 2, id = "level2_c_po"
  ) |> 
  tab_spanner(
    label = "Realized", columns = outcome, 
    level = 2, id = "level2_d_po") |> 
  
  # Style stuff
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(spanners = starts_with("level1")),
      cells_column_labels(columns = "id")
    )
  ) |> 
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_column_spanners(spanners = starts_with("level2"))
  ) |> 
  
  tab_style(
    style = list(
      cell_fill(color = clrs[4], alpha = 0.5)
    ),
    locations = cells_body(rows = treated == 1)
  ) |> 
  tab_footnote(
    footnote = "ite = individual causal effect",
    locations = cells_column_spanners(spanners = "level1_d_po")
  ) |> 
  opt_footnote_marks(marks = "standard") |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

## Efectos causales a nivel individual (ITE o $\delta$)

Cada persona de $Tabla 1$ tiene dos resultados potenciales. La persona 1, por ejemplo, tendr√≠a un resultado de 80 ($Y^1$) si recibe el tratamiento $X$, pero s√≥lo un resultado de 60 ($Y^0$) si no lo recibe. Su *efecto causal a nivel individual* ($\delta$) es de 20. Esto representa el efecto del tratamiento para el paciente. Esto representa el efecto del tratamiento s√≥lo para esa persona, y s√≥lo se puede medir con una m√°quina del tiempo o alguna forma de observar universos paralelos.

## Efectos medios del tratamiento (ATE)

Si pudi√©ramos comparar a todas estas personas en el Universo A y el Universo B y medir sus efectos causales individuales, podr√≠amos calcular el *efecto medio del tratamiento* (ATE), o el efecto de la intervenci√≥n en toda la poblaci√≥n. Oficialmente, el ATE es la media de la columna $\delta$, o la media de $Y^1 - Y^0$:

$$
\begin{aligned}
\text{ATE} &= E[\delta_i] & \text{ or} \\
\text{ATE} &= E[Y^1_i - Y^0_i]
\end{aligned}
$$

Dados los datos de la $Tabla 1$, el ATE es 5, es decir, la media de la columna $\delta$:

$$
\text{ATE} = \frac{20 + 5 + 5 + 5 + 10 + 0 + -10 + 5}{8} = 5
$$

## Efecto medio del tratamiento sobre los tratados (ATT)

Hay un par de efectos causales m√°s que podemos medir. Podr√≠amos querer saber la magnitud del efecto s√≥lo para los que recibieron el tratamiento. Esto se denomina *efecto medio del tratamiento sobre los tratados* (ATT), y es la media de los efectos causales individuales s√≥lo entre los que recibieron el tratamiento. Matematicamente, se define as√≠:

$$
\begin{aligned}
\text{ATT} &= E[\delta_i \mid X_i = 1] & \text{or} \\
\text{ATT} &= E[Y^1_i - Y^0_i \mid X_i = 1]
\end{aligned}
$$

En este caso, eso significa que s√≥lo estamos viendo el promedio $\delta$ para las filas 1, 2, 3 y 5 en $Tabla 1$:

$$
\text{ATT} = \frac{20 + 5 + 5 + 5}{4} = 8.75
$$

## Efecto medio del tratamiento sobre los no tratados (ATU)

Tambi√©n podemos calcular el *efecto medio del tratamiento sobre los no tratados* (ATU; a veces denominado ATC (por efecto sobre el grupo de control)) hallando la media de los efectos causales individuales entre los no tratados:

$$
\begin{aligned}
\text{ATU} &= E[\delta_i \mid X_i = 0] & \text{or} \\
\text{ATU} &= E[Y^1_i - Y^0_i \mid X_i = 0]
\end{aligned}
$$

Aqu√≠, s√≥lo estamos mirando el promedio $\delta$ para las filas 4, 6, 7 y 8 en $Tabla 1$:

$$
\text{ATU} = \frac{10 + 0 - 10 + 5}{4} = 1.25
$$

## Sesgo de selecci√≥n

Existe una clara relaci√≥n entre la ATE, la ATT y la ATU: la ATE es t√©cnicamente una media ponderada de la ATT sumada a la media ponderada de la ATU (aqu√≠ $\pi$ significa "proporci√≥n", no 3,1415):

$$
\text{ATE} = (\pi_\text{Treated} \times \text{ATT}) + (\pi_\text{Untreated} \times \text{ATU})
$$

Aplicando esto a $Tabla 1$, podemos obtener el mismo ATE:

$$
\begin{aligned}
\text{ATE} &= (\frac{4}{8} \times 8.75) + (\frac{4}{8} \times 1.25) \\
&= 4.375 + 0.625 \\
&= 5
\end{aligned}
$$

Una de las razones por las que es √∫til descomponer el ATE en estas dos partes es que muestra que hay alguna diferencia sistem√°tica entre las personas tratadas y las no tratadas. Esta diferencia se denomina "sesgo de selecci√≥n". Las personas que eligieron ser tratadas lo hicieron por razones que s√≥lo ellas conocen.

::: callout-note
## **NOTA**

No s√≥lo necesitamos una m√°quina del tiempo para una buena inferencia causal, tambi√©n necesitamos una m√°quina que pueda leer la mente de las personas para saber bajo que circunstancias optaran por la otra versi√≥n del tratamiento.
:::

Podemos ver el sesgo de selecci√≥n en una descomposici√≥n alternativa de la ATE:

$$
\text{ATE} = \text{ATT} + \text{Selection bias}
$$

El hecho de que la ATT (8,75) sea mayor que la ATE (5) es una se√±al de que los dos grupos son diferentes. Esta intervenci√≥n, sea cual sea, tiene un gran efecto en las personas tratadas que se apuntaron a ella, probablemente porque de alg√∫n modo sab√≠an que la intervenci√≥n les ser√≠a √∫til. Los que no recibieron tratamiento tienen una ATU realmente baja (1,25): probablemente no se apuntaron a la intervenci√≥n porque sab√≠an que no les ayudar√≠a mucho.

## üìåSupuestos causales

Como la mayor√≠a de los enfoques estad√≠sticos, la validez de un an√°lisis causal depende de qu√© tan bien se cumplan ciertos supuestos.

En el mundo real y en un momento dado, s√≥lo uno de estos resultados potenciales es observable: es decir, el resultado vinculado a la exposici√≥n real que sufri√≥ el individuo. Bajo ciertos supuestos, podemos aprovechar los datos de individuos expuestos a diferentes insumos para comparar las diferencias promedio en los resultados observados.

-   **Consistencia**: se debe tener en cuenta que la intervenci√≥n / exposici√≥n a evaluar para responder su pregunta causal debe ser igual para todos los individuos. Matem√°ticamente, esto significa que, la exposici√≥n que se observa en un individuo al azar es exactamente igual a la exposici√≥n que recibieron los dem√°s. Este supuesto puede descomponerse en:
    -   *Exposici√≥n bien definida*: asumimos que para cada valor de exposici√≥n, no hay diferencia entre los sujetos en la forma de medici√≥n y de clasificaci√≥n de esa exposici√≥n. Dicho de otra manera, no existen m√∫ltiples versiones del tratamiento.
    -   *Ausencia de interferencia entre las unidades*: asumimos que el resultado (t√©cnicamente todos los resultados potenciales , independientemente de si se observan) para cualquier sujeto no depende de la exposici√≥n de otro sujeto.
    -   **NOTA:** El supuesto 1 a veces se denomina supuesto de valor de tratamiento unitario estable o SUTVA (stable-unit-treatment-value-assumption, Imbens y Rubin 2015) . Del mismo modo, estos supuestos a veces se denominan condiciones de identificabilidad, ya que necesitamos que se cumplan para identificar estimaciones causales.
-   **Intercambiabilidad**: se debe asumir que los sujetos expuestos y no expuestos tienen la misma probabilidad de experimentar cualquier resultado antes de la exposici√≥n; es decir, los sujetos expuestos y no expuestos son intercambiables (por ende el ATT deber√≠a ser igual al ATU e igual al ATE). A veces se hace referencia a esta suposici√≥n como que no existe ning√∫n factor de confusi√≥n no medido.
    -   Visto de una forma pr√°ctica: tanto los que reciben la intervenci√≥n como aquellos que no la recibieron, deben tener la misma probabilidad (x% en ambos) de desarrollar el desenlace.
    -   No puedes comparar un grupo donde la probabilidad de desarrollar un evento sea del 60% vs otro grupo que solo tiene la probabilidad del 10%, ser√≠a injusto, ¬øno?
-   **Positividad**: Asumimos que dentro de cada nivel y combinaci√≥n de las variables de estudio (cada individuo dentro de cada subgrupo posible) tiene alguna posibilidad de experimentar todos los niveles de la exposici√≥n. A veces esto se denomina supuesto probabil√≠stico .
    -   Visto de una forma pr√°ctica: tanto los que recibieron la intervenci√≥n como aquellos que no la recibieron, tuvieron una probabilidad \>0% (un valor positivo) de ser asignados a los brazos evaluados.

**NOTA:** En la pr√°ctica, la mayor√≠a de las suposiciones que necesitamos hacer para la inferencia causal son para que podamos hacer una comparaci√≥n de manzanas con manzanas, ya que, queremos asegurarnos de que estamos comparando individuos que son similares, que servir√≠an como buenos sustitutos de los contrafactuales de cada uno.

## Causalidad en ensayos cl√≠nicos

*¬øPor qu√© es √∫til la aleatorizaci√≥n?*

Si observamos nuestros supuestos, los ensayos aleatorios resuelven en parte el supuesto de consistencia (la parte de exposici√≥n bien definida de forma predeterminada): ya que es dicha exposici√≥n lo que se aleatoriza. Lo mismo ocurre con la positividad; Si hemos asignado personas al azar a los grupos expuestos o no expuestos, conocemos la probabilidad de asignaci√≥n (y sabemos que no es exactamente 0 o 1, en la mayoria de casos esa probabilidad se acerca al 50%).

Sin embargo, la aleatorizaci√≥n por s√≠ sola no resuelve la parte de "no interferencia" del supuesto de consistencia, por ejemplo, si aleatorizamos a algunas personas para que reciban una vacuna contra una enfermedad transmisible, recibirla podr√≠a reducir la posibilidad de que quienes los rodean contraigan la enfermedad infecciosa porque cambia la probabilidad de exposici√≥n (efecto reba√±o); otro ejemplo puede ser revisado con casos de efecto de derrame ("spillover bias").

Los ensayos aleatorios ideales resuelven la cuesti√≥n de la intercambiabilidad porque las poblaciones expuestas y no expuestas (en el l√≠mite) son inherentemente las mismas, ya que su estado de exposici√≥n se determin√≥ mediante un proceso aleatorio (no por ning√∫n factor que pudiera hacerlas diferentes entre s√≠).

*¬°Cuidado!* En realidad, a menudo vemos que esta suposici√≥n es violada por cuestiones como el abandono o la falta de adherencia en los ensayos aleatorios. Si hay un abandono diferencial entre los grupos de exposici√≥n (por ejemplo, si los participantes asignados aleatoriamente al tratamiento tienen m√°s probabilidades de abandonar un estudio y, por lo tanto, no observamos su resultado), entonces los grupos de exposici√≥n observados ya no son intercambiables. . Por lo tanto, nos enfrentaremos por una para el ensayo aleatorio ideal (donde se supone que la adherencia es perfecta y ning√∫n participante abandona) y otra para los ensayos aleatorios realistas donde esto puede no ser as√≠.

**¬øSolo la aleatorizaci√≥n garantiza que se cumpla estos supuestos?**

Se tiene que tener en cuenta que se requiere m√°s que la aleatorizaci√≥n para garantizar los supuestos:

-   Criterio de elegibilidad estrictos (si un participante no cumple todos los criterios no es elegible)

-   Definici√≥n exacta de la exposici√≥n (los investigadores controlan todas las condiciones)

-   Procedimientos de asignaci√≥n (idealmente mediante un metodo aleatorio y garantizando el ocultamiento de la secuencia aleatoria y posterior cegamiento de la intervenci√≥n)

-   Per√≠odo de seguimiento (donde podr√≠a permitirse perdidas aleatorias en el seguimiento y en un porcentaje minimo)

-   Definici√≥n de resultados (garantizar que la forma de medici√≥n se igual para todos)

-   Plan de an√°lisis

Veamos como estos elementos garantizan los supuestos. Por ejemplo, la intercambiabilidad puede abordarse mediante los criterios de elegibilidad (podemos restringir nuestro estudio solo a participantes para quienes la asignaci√≥n de exposici√≥n es intercambiable), el procedimiento de asignaci√≥n (podr√≠amos usar una asignaci√≥n de exposici√≥n aleatoria para garantizar la intercambiabilidad), el per√≠odo de seguimiento (podemos asegurarnos de elegir un momento de inicio apropiado para nuestro per√≠odo de seguimiento para asegurarnos de que no induzcamos sesgos; pensaremos m√°s en esto en un cap√≠tulo futuro) y/o el plan de an√°lisis (podemos ajustar cualquier factor que pueda causar que los grupos no sean intercambiables \[factores confusores\]).

```{r echo =FALSE}
library(gt)

# Crear la tabla con los datos
tabla_suposiciones <- tribble(
  ~Suposici√≥n, ~Criterio_de_elegibilidad, ~Definici√≥n_de_exposici√≥n, ~Procedimientos_de_asignaci√≥n, ~Per√≠odo_de_seguimiento, ~Definici√≥n_de_resultados, ~Contraste_causal, ~Plan_de_an√°lisis,
    "Consistencia (exposici√≥n bien definida)", "‚úîÔ∏è", "‚úîÔ∏è", "", "", "", "", "",
  "Consistencia (sin interferencias)", "", "‚úîÔ∏è", "‚úîÔ∏è", "", "‚úîÔ∏è", "", "‚úîÔ∏è",
  "Positividad", "‚úîÔ∏è", "", "‚úîÔ∏è", "", "", "‚úîÔ∏è", "",
  "Intercambiabilidad", "‚úîÔ∏è", "", "‚úîÔ∏è", "‚úîÔ∏è", "" , "", "‚úîÔ∏è",
)

# Formatear la tabla con gt
tabla_suposiciones %>%
  gt() %>%
  tab_style(
    style = cell_text(weight = "bold", align = "center"),
    locations = cells_column_labels()
  ) %>%
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) %>%
  tab_options(
    table.width = pct(100),
    table.font.size = "medium"
  ) %>%
  opt_horizontal_padding(scale = 2)

```

# M√°s all√° de la aleatorizaci√≥n

Hay muchas razones por las que la aleatorizaci√≥n puede no ser posible. Por ejemplo, puede que no sea √©tico asignar personas al azar a una exposici√≥n particular, puede que no haya fondos disponibles para realizar un ensayo aleatorio o puede que no haya tiempo suficiente para realizar un ensayo completo. En estas situaciones, confiamos en datos del mundo real (datos observacionales) que nos ayudar√°n a responder preguntas causales mediante la emulaci√≥n de un ensayo cl√≠nico objetivo.

Un ensayo objetivo responde: ¬øQu√© experimento dise√±ar√≠as si fuera posible? Especificar un ensayo objetivo es casi id√©ntico al proceso que describimos para un ensayo aleatorio. Definimos la elegibilidad, la exposici√≥n, el per√≠odo de seguimiento, el resultado, la estimaci√≥n de inter√©s y el plan de an√°lisis. La diferencia clave con el ensayo objetivo en el entorno observacional, por supuesto, es que no podemos asignar la intervenci√≥n. El paso de planificaci√≥n del an√°lisis y ejecuci√≥n de la prueba objetivo es el m√°s complicado desde el punto de vista t√©cnico y un enfoque central de este programa; por ejemplo, usar DAG para garantizar que hemos medido y estamos controlando el conjunto correcto de factores de confusi√≥n, componer programas estad√≠sticos que invoquen un m√©todo de ajuste apropiado, como la ponderaci√≥n de IPW, y realizar an√°lisis de sensibilidad para evaluar qu√© tan sensibles son nuestras conclusiones a errores de especificaci√≥n o confusi√≥n no medidos.

## Hallar el ATE a partir de datos observacionales

Todo esto est√° muy bien, pero no tenemos m√°quinas del tiempo para observar los dos resultados potenciales y la verdad es que solo podremos saber uno de los resultados. A esto se le denomina el *problema fundamental de la inferencia causal* (no tenemos ni idea de cu√°l es el $\delta$ de cada persona).

De hecho, s√≥lo vemos esto en la vida real:

```{r echo =FALSE}
#| label: tbl-basic-realized
#| tbl-cap: "Observed version of @tbl-basic-po showing only the realized outcome"
#| code-fold: true
#| classes: no-stripe

basic_po |> 
  select(
    id, age, treated, outcome
  ) |> 
  gt() |> 
  fmt_number(
    columns = "outcome",
    decimals = 0
  ) |> 

  # Column labels
  cols_label(
    id = "ID",
    age = md("$Z_i$"),
    treated = md("$X_i$"),
    outcome = md("$Y_i$")
  ) |>
  
  # Level 1 spanner labels
  tab_spanner(
    label = "Age", columns = age, 
    level = 1, id = "level1_a_po_obs"
  ) |> 
  tab_spanner(
    label = "Treated", columns = treated, 
    level = 1, id = "level1_b_po_obs"
  ) |> 
  tab_spanner(
    label = "Outcome", columns = outcome, 
    level = 1, id = "level1_c_po_obs"
  ) |> 
  
  # Level 2 spanner labels
  tab_spanner(
    label = "Confounder",
    columns = age,
    level = 2, id = "level2_a_po_obs"
  ) |> 
  tab_spanner(
    label = "Treatment", columns = treated, 
    level = 2, id = "level2_b_po_obs"
  ) |> 
  tab_spanner(
    label = "Realized", columns = outcome, 
    level = 2, id = "level2_c_po_obs") |> 
  
  # Style stuff
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(spanners = starts_with("level1")),
      cells_column_labels(columns = "id")
    )
  ) |> 
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_column_spanners(spanners = starts_with("level2"))
  ) |> 

  tab_style(
    style = list(
      cell_fill(color = clrs[4], alpha = 0.5)
    ),
    locations = cells_body(rows = treated == 1)
  ) |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

Podr√≠amos intentar hallar el ATE calculando el resultado medio entre los tratados ($\bar{Y}_\text{Tratados}$) y rest√°ndolo del resultado medio entre los no tratados ($\bar{Y}_\text{No tratados}$):

$$
\begin{aligned}
\text{ATE}_\text{naive} &= \bar{Y}_\text{Treated} - \bar{Y}_\text{Untreated} \\
&= \frac{80 + 75 + 85 + 75}{4} - \frac{60 + 80 + 100 + 80}{4} \\
&= 78.75 - 80 \\
&= -1.25
\end{aligned}
$$

Pero esto es terriblemente err√≥neo. El sesgo de selecci√≥n est√° distorsionando el efecto causal. Las personas tratadas buscaron el tratamiento porque sab√≠an que ser√≠a bueno para ellas. No podemos comparar los dos grupos directamente de esta manera debido a las diferencias sistem√°ticas entre ellos.

Tenemos que tener en cuenta de alguna manera el hecho de que los dos grupos son diferentes. Durante todo este tiempo hemos ignorado una columna de la tabla: la edad ($Z$). Parece que la edad est√° muy correlacionada con el estado del tratamiento. El 75% de las personas que se apuntaron al tratamiento eran mayores; el 75% de las personas que no se apuntaron al tratamiento eran j√≥venes. En t√©rminos de DAG, la edad parece ser un factor de confusi√≥n: causa tanto la elecci√≥n de recibir tratamiento como el valor final del resultado. La edad abre una puerta trasera en la relaci√≥n entre el tratamiento y el resultado y desordena el efecto causal. Si de alg√∫n modo podemos tener en cuenta estad√≠sticamente la edad, obtendremos una estimaci√≥n m√°s precisa de la ATE real.

**NOTA: ¬øQuiz√°s este tratamiento es una colonoscopia? usa tu imaginaci√≥n.**

```{r echo =FALSE}
#| label: fig-dag-basic
#| fig-cap: "DAG showing that age confounds the relationship between treatment and outcome"
#| code-fold: true
#| fig-width: 4.5
#| fig-height: 2.5
#| out-width: "70%"

basic_dag <- dagify(
  Y ~ X + Z,
  X ~ Z,
  exposure = "X",
  outcome = "Y",
  coords = list(
    x = c(X = 1, Y = 3, Z = 2),
    y = c(X = 1, Y = 1, Z = 2)
  )
)

basic_dag_plot <- basic_dag |> 
  tidy_dagitty() |> 
  mutate(var_type = case_when(
    name == "X" ~ "Exposure",
    name == "Y" ~ "Outcome",
    str_detect(name, "Z") ~ "Confounder"
  )) |> 
  mutate(var_label = case_match(name,
    "X" ~ "Treatment",
    "Y" ~ "Outcome",
    "Z" ~ "Age"
  ))

ggplot(basic_dag_plot, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges() +
  geom_dag_point(aes(color = var_type), size = 12) +
  geom_richtext(
    aes(label = name), fontface = "bold", color = "white",
    fill = NA, label.color = NA,
    label.padding = grid::unit(c(3, 0, 0, 0), "pt")
  ) + 
  geom_dag_text(
    data = filter(basic_dag_plot, var_type != "Confounder"), aes(label = var_label), 
    nudge_y = -0.25, color = "black", size = 11, size.unit = "pt"
  ) +
  geom_dag_text(
    data = filter(basic_dag_plot, var_type == "Confounder"), aes(label = var_label), 
    nudge_y = 0.26, color = "black", size = 11, size.unit = "pt"
  ) +
  scale_color_manual(values = clrs[c(4, 1, 6)], guide = "none") +
  theme_dag()
```

Existen muchas formas de ajustar la edad (hay libros de texto enteros sobre este tema: emparejamiento, ponderaci√≥n de probabilidad inversa, etc.). Una forma sencilla es estratificar por edad y hallar la suma de las medias ponderadas de los mayores y los j√≥venes, de la siguiente manera:

$$
\text{ATE} = (\pi_\text{Old} \times \text{Effect}_\text{Old}) + (\pi_\text{Young} \times \text{Effect}_\text{Young})
$$

Con los datos de la tabla, obtenemos:

$$
\begin{aligned}
\text{Effect}_\text{Stratified} &= (\pi_\text{Treated} \times \bar{Y}_\text{Treated}) - (\pi_\text{Untreated} \times \bar{Y}_\text{Untreated}) \\[20pt]
\text{Effect}_\text{Old} &= \frac{80 + 75 + 85}{3} - \frac{60}{1} &&= 20 \\
\text{Effect}_\text{Young} &= \frac{75}{1} - \frac{80 + 100 + 80}{3} &&= -11.667 \\[20pt]
\text{ATE} &= (\frac{4}{8} \times 20) + (\frac{4}{8} \times -11.667) &&= 4.1667
\end{aligned}
$$

4,1667 no es exactamente el verdadero ATE (cuando teniamos toda la info vimos que el verdaedro valor de ATE era 5), ¬°pero est√° sorprendentemente cerca! Si tuvi√©ramos m√°s de 8 filas de datos, nos acercar√≠amos a√∫n m√°s (siempre que la edad fuera realmente el √∫nico factor de confusi√≥n).

Recorrer una tabla como √©sta es un ejercicio √∫til. Ilustra c√≥mo los efectos causales individuales son inobservables. Muestra c√≥mo podr√≠amos encontrar te√≥ricamente el efecto medio del tratamiento de alguna intervenci√≥n. Destaca el papel que desempe√±an el sesgo de selecci√≥n y la confusi√≥n en la distorsi√≥n de los efectos causales. Se√±ala formas de tener en cuenta la confusi√≥n mediante ajustes estad√≠sticos.

Exploremos los matices de los distintos tipos de efectos del tratamiento utilizando un conjunto de datos de resultados potenciales m√°s realista, basado en una hipot√©tica intervenci√≥n de desarrollo internacional dise√±ada para reducir el riesgo de paludismo mediante el uso de mosquiteros. Los datos son observacionales y no experimentales: las personas deciden utilizar o no las mosquiteros en funci√≥n de sus preferencias personales. En este caso, los ingresos y la salud confunden la relaci√≥n mosquitero ‚Üí riesgo de paludismo: los ingresos influyen en la salud, y tanto los ingresos como la salud influyen en la decisi√≥n de utilizar una mosquitero y en el riesgo general de paludismo.

```{r echo = FALSE}
#| label: fig-dag-mosquito
#| fig-cap: "DAG showing the relationship between mosquito net use and malaria risk, confounded by health and income"
#| code-fold: true
#| fig-width: 6
#| fig-height: 3.5

mosquito_dag <- dagitty('
dag {
"X" [exposure,pos="1,1"]
"Y" [outcome,pos="4,1"]
"Z<sub>1</sub>" [pos="2,2"]
"Z<sub>2</sub>" [pos="3,2"]
"Z<sub>2</sub>" -> "Y"
"Z<sub>2</sub>" -> "X"
"Z<sub>1</sub>" -> "Y"
"Z<sub>1</sub>" -> "Z<sub>2</sub>"
"Z<sub>1</sub>" -> "X"
"X" -> "Y"
}')

dag_plot <- mosquito_dag |> 
  tidy_dagitty() |> 
  mutate(var_type = case_when(
    name == "X" ~ "Exposure",
    name == "Y" ~ "Outcome",
    str_detect(name, "Z") ~ "Confounder"
  )) |> 
  mutate(var_label = case_match(name,
    "X" ~ "Mosquito net",
    "Y" ~ "Malaria risk",
    "Z<sub>1</sub>" ~ "Income",
    "Z<sub>2</sub>" ~ "Health"
  ))

ggplot(dag_plot, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_dag_edges() +
  geom_dag_point(aes(color = var_type), size = 12) +
  geom_richtext(
    aes(label = name), fontface = "bold", color = "white",
    fill = NA, label.color = NA,
    label.padding = grid::unit(c(3, 0, 0, 0), "pt")
  ) + 
  geom_dag_text(
    data = filter(dag_plot, var_type != "Confounder"), aes(label = var_label), 
    nudge_y = -0.15, color = "black", size = 11, size.unit = "pt"
  ) +
  geom_dag_text(
    data = filter(dag_plot, var_type == "Confounder"), aes(label = var_label), 
    nudge_y = 0.16, color = "black", size = 11, size.unit = "pt"
  ) +
  scale_color_manual(values = clrs[c(4, 1, 6)], guide = "none") +
  theme_dag()
```

**En este conjunto de datos, la verdadera ATE es -15.** El uso de un mosquitero provoca una disminuci√≥n media de 15 unidades en el riesgo de paludismo en toda la poblaci√≥n.

Veamos la base de datos a utilizar

```{r echo =FALSE}
#| label: generate-data
#| code-fold: true
#| code-summary: "Code for generating synthetic mosquito net data"

withr::with_seed(1234, {
  n <- 1500
  
  nets <- tibble(
    # Generate exogenous variables
    id = 1:n,
    income = rnorm(n, 500, 100)
  ) |> 
    # Generate health, which depends on income
    mutate(
      health = (0.1 * income) + rnorm(n, 0, 10),
      health = pmin(pmax(health, 0), 100)  # Force values to 0-100 range
    ) |> 
    # Generate net usage (treatment), which depends on health and income
    mutate(
      # Make people with high health and high income a lot more likely to
      # self-select into treatment
      income_high = income > quantile(income, 0.8),
      health_high = health > quantile(health, 0.8),
      
      # Create latent propensity scores based on logit formula
      net_prob = plogis(
        -3 + (income / 300) + (health / 40) + 
          (0.9 * income_high) + (0.5 * health_high)),
      
      # Assign to treatment
      net = rbinom(n, 1, 
        # Fancy little trick---increase the latent propensity score by 5
        # percentage points for people already more likely (i.e. p > 50%) to
        # receive treatment and decrease the propensity score by 8 percentage
        # points for those already less likely to receive treatment
        prob = ifelse(
          net_prob > 0.5, 
          pmin(net_prob + 0.05, 0.98), 
          pmax(net_prob - 0.08, 0.02))
        )
    ) |> 
    # Generate potential and actual outcomes
    mutate(
      # Individual outcomes in a world where individuals are not treated
      malaria_risk_0 = 90 + (-0.2 * health) + (-0.05 * income) + rnorm(n, 0, 6),
      malaria_risk_0 = pmin(pmax(malaria_risk_0, 0), 100),  # Force values to 0-100
      
      # Individual outcomes in a world where individuals are treated
      # Basically risk_0 + a baseline treatment effect + extra treatment effect
      # boosts because of income and health
      malaria_risk_1 = malaria_risk_0 - 
        rnorm(n, 3, 1) - (0.015 * income) - (0.09 * health),
      malaria_risk_1 = pmin(pmax(malaria_risk_1, 0), 100),  # Force values to 0-100
      
      # Round stuff
      malaria_risk_0 = round(malaria_risk_0, 1),
      malaria_risk_1 = round(malaria_risk_1, 1),
      
      ite = malaria_risk_1 - malaria_risk_0,
      
      # Actual realized outcome
      malaria_risk = ifelse(net == 1, malaria_risk_1, malaria_risk_0)
    ) |> 
    # Round more stuff
    mutate(across(c(income, health), ~round(., 0))) |> 
    # Only keep some columns
    select(
      id, income, income_high, health, health_high, net,
      starts_with("malaria"), ite
    )
})

write_csv(nets, "mosquito_nets_v2.csv")

#nets

DT::datatable(nets,  options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )

```

Tenemos cuatro variables principales en estos datos:

-   **Uso del mosquitero** *(Tratamiento)*: Variable binaria 0/1, VERDADERO/FALSO, que indica si la persona utiliza un mosquitero.

-   **Riesgo de paludismo** *(Resultado)*: Escala de 0-100, donde los valores m√°s altos representan un mayor riesgo.

-   **Ingresos** *(factor de confusi√≥n)*: Ingresos semanales, medidos en d√≥lares. A mayores ingresos, mayor probabilidad de utilizar mosquitero; las personas por encima del percentil 80 obtienen un aumento adicional de la probabilidad.

-   **Salud** *(factor de confusi√≥n)*: Estado de salud, escala de 0 a 100; los valores m√°s altos representan un mejor estado de salud. Un mejor estado de salud provoca una mayor probabilidad de utilizar un mosquitero; las personas por encima del percentil 80 obtienen un aumento adicional de la probabilidad.

```{r echo =FALSE}
#| label: tabla_2
#| tbl-cap: "Potential outcomes, individual causal effects, and realized outcomes for synthetic mosquito net data"
#| code-fold: true
#| classes: no-stripe

excerpt <- nets |> 
  slice(c(3, 14, 15, 29, 4, 35, 37, 73)) |> 
  arrange(id)

excerpt |> 
  add_row(id = NA) |> 
  select(
    id, income, health, net, 
    malaria_risk_1, malaria_risk_0, ite, malaria_risk
  ) |> 
  gt() |> 
  sub_missing(missing_text = "‚Ä¶") |>
  fmt_number(
    columns = c(starts_with("malaria_risk"), ite),
    decimals = 1
  ) |> 
  fmt_number(columns = c(income, health), decimals = 0) |> 
  
  # Column labels
  cols_label(
    id = "ID",
    income = md("$Z_{1_i}$"),
    health = md("$Z_{2_i}$"),
    net = md("$X_i$"),
    malaria_risk_0 = md("$Y^0_i$"),
    malaria_risk_1 = md("$Y^1_i$"),
    malaria_risk = md("$Y_i$"),
    ite = md("$Y^1_i - Y^0_i$")
  ) |>
  
  # Level 1 spanner labels
  tab_spanner(
    label = "Income", columns = income, 
    level = 1, id = "level1_a"
  ) |> 
  tab_spanner(
    label = "Health", columns = health, 
    level = 1, id = "level1_b"
  ) |> 
  tab_spanner(
    label = "Net use", columns = net, 
    level = 1, id = "level1_c"
  ) |> 
  tab_spanner(
    label = "Potential outcomes",
    columns = c(malaria_risk_1, malaria_risk_0),
    level = 1, id = "level1_d"
  ) |> 
  tab_spanner(
    label = "ICE or \\(\\delta_i\\)", columns = ite, 
    level = 1, id = "level1_e"
  ) |> 
  tab_spanner(
    label = "Outcome", columns = malaria_risk, 
    level = 1, id = "level1_f"
  ) |> 
  
  # Level 2 spanner labels
  tab_spanner(
    label = "Confounders",
    columns = c(income, health),
    level = 2, id = "level2_a"
  ) |> 
  tab_spanner(
    label = "Treatment", columns = net, 
    level = 2, id = "level2_b"
  ) |> 
  tab_spanner(
    label = "Unobservable",
    columns = c(malaria_risk_1, malaria_risk_0, ite), 
    level = 2, id = "level2_c"
  ) |> 
  tab_spanner(
    label = "Realized", columns = malaria_risk, 
    level = 2, id = "level2_d") |> 
  
  # Style stuff
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(spanners = starts_with("level1")),
      cells_column_labels(columns = "id")
    )
  ) |> 
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_column_spanners(spanners = starts_with("level2"))
  ) |> 
  
  tab_style(
    style = list(
      cell_fill(color = clrs[4], alpha = 0.5)
    ),
    locations = cells_body(rows = net == 1)
  ) |> 
  tab_footnote(
    footnote = "ite = individual causal effect",
    locations = cells_column_spanners(spanners = "level1_e")
  ) |> 
  opt_footnote_marks(marks = "standard") |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

Utilicemos estos datos para explorar y calcular tres estimandos diferentes: el ATE, el ATT y el ATU. Para cada estimando, haremos lo siguiente:

1.  Traduciremos de forma sencilla lo que mide el estimando y explicaremos por qu√© nos interesa.

2.  Calcular el estimando utilizando los efectos causales individuales verdaderos pero no observables (ITE), o $\delta$.

3.  Calcular el estimando utilizando puntuaci√≥n de propensi√≥n basada en ponderaci√≥n y el c√°lculo g (g-computation)

## Traducciones simples y valores verdaderos

Este es el aspecto de los datos sint√©ticos de `nets`: tenemos columnas para cada una de las columnas de la tabla 2, as√≠ como algunos indicadores para saber si los ingresos y la salud est√°n por encima del percentil 80:

```{r}
#| label: show-nets-initial
nets |> glimpse()
```

## ATE

```{r}
#| label: calc-ate-true-hidden
#| include: false

nice_number <- scales::label_number(style_negative = "minus", accuracy = 0.1)

true_ate <- mean(nets$ite)
```

El efecto medio del tratamiento (ATE) es lo que siempre he supuesto que la gente quiere encontrar cuando hace inferencia causal. Representa el efecto del uso de mosquiteros en toda la poblaci√≥n, incluso si las personas no recibir√≠an normalmente el tratamiento.

Se trata de una estimaci√≥n muy amplia, por lo que es adecuada para pol√≠ticas de gran alcance que puedan influir en toda la poblaci√≥n, por ejemplo, si un gobierno se plantea distribuir mosquiteros gratuitas o subvencionadas a todos los habitantes del pa√≠s.

$$
\begin{aligned}
\text{ATE} &= E[\delta_i] & \text{ or} \\
\text{ATE} &= E[Y^1_i - Y^0_i]
\end{aligned}
$$

Conceptualmente, esto es lo mismo que imaginar dos mundos hipot√©ticos: en el Universo A damos a todo el mundo un mosquitero (aunque no lo necesite), y en el Universo B no damos a nadie un mosquitero. A continuaci√≥n, calculamos la diferencia de efectos causales individuales entre esos mundos.

Si nos fijamos s√≥lo en las ocho filas de los datos sobre mosquiteros de la tabla, la ATE ser√≠a de -13,36:

$$
\frac{(-17.8) + (-9.8) + (-16.9) + (-16) + (-15.6) + (-10.4) + (-8.9) + (-11.5)}{8} = -13.36
$$

Podemos calcularlo con los datos completos tomando la media de la columna ICE. Es `r nice_number(true_ate)`, que es lo que he realizado en los datos:

```{r}
#| label: calc-ate-po
nets |> 
  # I included the alternative versions here just to show that it's 
  # the average of Y1 - average of Y0
  summarize(
    ATE = mean(ite),
    ATE_alt1 = mean(malaria_risk_1) - mean(malaria_risk_0),
    ATE_alt2 = mean(malaria_risk_1 - malaria_risk_0)
  )
```

## ATT

```{r}
#| label: calc-att-true-hidden
#| include: false

true_att <- nets |> 
  filter(net == 1) |> 
  summarize(ATT = mean(ite)) |> 
  pull(ATT)
```

El efecto medio del tratamiento sobre los tratados (ATT) es m√°s limitado que el ATE, pero (¬°sorprendentemente!) suele ser m√°s √∫til y relevante desde el punto de vista pol√≠tico. Representa el efecto del uso de mosquiteros, pero s√≥lo para las personas que usan mosquiteros. Esto resulta extra√±o, as√≠ que aqu√≠ van otros ejemplos:

```{r echo =FALSE}
#| label: tbl-ate-vs-att
#| tbl-cap: "Different types of causal effects that can be found as ATEs and ATTs"
#| code-fold: true
#| classes: no-stripe

tribble(
  ~ATE, ~ATT,
  "Efecto de mosquiteros para todos en el pa√≠s", "Efecto de mosquiteros para personas que los utilizan",
  "Efecto del servicio militar para solicitantes t√≠picos al ej√©rcito", "Efecto del servicio militar para soldados t√≠picos",
  "Efecto de un programa de capacitaci√≥n laboral en todos los residentes de un estado", "Efecto de un programa de capacitaci√≥n laboral en todos los que lo utilizaron",
  "Efecto de un nuevo medicamento contra el c√°ncer en todos en el mundo", "Efecto de un nuevo medicamento contra el c√°ncer en personas con c√°ncer"
) |> 
  gt() |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) |> 
  tab_footnote(
    footnote = html("Example via <a href='https://stats.stackexchange.com/a/455012/3025'>this Cross Validated response</a>"),
    locations = cells_body(columns = ATE, rows = 2)
  ) |> 
  opt_footnote_marks(marks = "standard") |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

El ATT se siente mucho m√°s √∫til para prop√≥sitos de pol√≠tica. En medicina, se siente mal juzgar la efectividad de un nuevo medicamento basado en el efecto que tendr√≠a en cada persona; en evaluaci√≥n de programas, se siente mal juzgar la efectividad de un programa de capacitaci√≥n en todos, incluso si nunca lo usar√≠an.

¬°Tanto el ATE como el ATT son estimaciones √∫tiles para la pol√≠tica!

Conceptualmente, podemos imaginar dos mundos paralelos nuevamente: en el Universo A le damos a todos los que actualmente usan un mosquitero, y en el Universo B quitamos esos mosquiteros. Luego calculamos la diferencia entre esos mundos. El ATT representa as√≠ el efecto de retener los mosquiteros de aquellos que los habr√≠an usado.

¬°PERO(!!!), pensar en el ATT se siente extra√±o, parece que estamos abandonando toda la idea de un grupo de control y solo mirando al grupo tratado.

¬øRealmente solo estamos mirando a las personas tratadas?

Veamos la formula del ATT:

$$
\begin{aligned}
\text{ATT} &= E[\delta_i \mid X_i = 1] & \text{or} \\
\text{ATT} &= E[Y^1_i - Y^0_i \mid X_i = 1]
\end{aligned}
$$

Esa parte condicional $[\dots \mid X = 1]$ dice que s√≥lo estamos mirando a las personas tratadas. Y cuando lo calculamos con datos hipot√©ticos, realmente s√≥lo nos fijamos en las personas tratadas. As√≠, si s√≥lo nos fijamos en las ocho filas en la tabla, el ATT ser√≠a -16,58:

$$
\frac{(-17.8) + (-16.9) + (-16) + (-15.6)}{4} = -16.58
$$

Podemos calcularlo con los datos completos tomando la media de la columna ITE despu√©s de filtrar los datos para que s√≥lo nos fijemos en las personas que utilizan un mosquitero. En este ejemplo el ATT es superior al ATE (lo que implica un sesgo de selecci√≥n).

```{r}
#| label: calc-att-po
nets |> 
  filter(net == 1) |> 
  summarize(ATT = mean(ite))
```

Por eso el ATT puede resultar extra√±o. Ya no estamos encontrando la diferencia entre las personas tratadas y no tratadas; estamos mirando s√≥lo a las personas tratadas y de alguna manera encontrar un efecto causal.

De hecho, ¬°creo que la tabla est√° haciendo las cosas m√°s confusas al calcular el ATT con datos observados! Cualquier efecto causal es la diferencia entre dos n√∫meros. Como tenemos datos basados en m√°quinas del tiempo, estamos encontrando la diferencia entre lo que habr√≠a ocurrido en el Universo A y en el Universo B, s√≥lo para las personas tratadas. En la vida real, sin embargo, donde no tenemos una m√°quina del tiempo, no podemos encontrar esa diferencia. Todav√≠a tenemos que comparar a las personas tratadas con las no tratadas. Simplemente haremos un trabajo estad√≠stico adicional para que las personas no tratadas sean m√°s comparables a las tratadas.

As√≠ pues, *con datos hipot√©ticos comparamos a las personas tratadas con su yo paralelo e ignoramos a las no tratadas.*

## ATU

```{r}
#| label: calc-atu-true-hidden
#| include: false

true_atu <- nets |> 
  filter(net == 0) |> 
  summarize(ATT = mean(ite)) |> 
  pull(ATT)
```

El efecto medio del tratamiento para los no tratados (ATU) es igual que el ATT, pero a la inversa. Representa el efecto del uso de mosquiteros para las personas que no las utilizan.

Volvamos a los dos mundos paralelos: en el Universo A solo evaluaremos a los que *no* usan un mosquitero actualmente, y en el Universo B entregamos el mosquitero a todos los que *no* lo usan en el universo A. A continuaci√≥n, calculamos la diferencia entre esos mundos. La ATU representa el efecto del tratamiento en quienes no lo recibieron.

Lo calculamos con datos hipot√©ticos tomando la media de los efectos causales individuales (ITE) para las personas no tratadas:

$$
\begin{aligned}
\text{ATU} &= E[\delta_i \mid X_i = 0] & \text{or} \\
\text{ATU} &= E[Y^1_i - Y^0_i \mid X_i = 0]
\end{aligned}
$$

Si nos fijamos s√≥lo en la tabla, el ATU ser√≠a -10,15:

$$
\frac{(-9.8) + (-10.4) + (-8.9) + (-11.5)}{4} = -10.15
$$

Podemos calcularlo con los datos completos tomando la media de la columna ITE despu√©s de filtrar los datos para que s√≥lo nos fijemos en las personas que *no* utilizan red. Es ATU inferior a la ATE (de nuevo, lo que implica un sesgo de selecci√≥n).

```{r}
#| label: calc-atu-po
nets |> 
  filter(net == 0) |> 
  summarize(ATU = mean(ite))
```

Al igual que con el ATT, con datos hipot√©ticos comparamos a las personas no tratadas con sus versiones paralelas e ignoramos a las tratadas.

## Sesgo de selecci√≥n e implicancia sobre el ATE, ATT y ATU

Antes de calcular estos diferentes efectos del tratamiento con los resultados realizados en lugar de los resultados potenciales hipot√©ticos, echemos un vistazo r√°pido a la diferencia pr√°ctica entre el verdadero ATE, ATT y ATU. ¬°Los tres estimadores son √∫tiles para la formulaci√≥n de pol√≠ticas!

El ATE es ‚àí15, lo que implica que los mosquiteros causan una reducci√≥n en promedio de 15 puntos en el riesgo de malaria para cada persona en el pa√≠s. Esto incluye a personas que viven en elevaciones altas donde los mosquitos no viven, personas que viven cerca de pantanos infestados de mosquitos, personas lo suficientemente ricas como para comprar el l√°ser antimosquitos de Bill Gates, y personas que no pueden permitirse un mosquitero pero les gustar√≠a usar uno.

Sin embargo, si trabaj√°ramos en el Ministerio de Salud y quisi√©ramos saber si deber√≠amos implementar un nuevo programa nacional que entregara a todos los peruanos un mosquitero gratis, la reducci√≥n general en el riesgo de ‚àí15 podr√≠a ser no realista.

El ATT es ‚àí16.29, que es m√°s grande que el ATE. El efecto del uso del mosquitero es mayor para las personas que ya est√°n usando los mosquiteros. Esto se debe a razones sistem√°ticas subyacentes o sesgo de selecci√≥n. Aquellos que usan mosquiteros quieren usarlos porque los necesitan m√°s o pueden acceder a ellos m√°s f√°cilmente, viven en √°reas m√°s propensas a los mosquitos o pueden permitirse comprar sus propios mosquiteros, entre otras cosas. Se conocen a s√≠ mismos y entienden alguna noci√≥n de su efecto causal individual personal y buscan mosquiteros. Si les quit√°ramos el acceso a sus mosquiteros, tendr√≠a un efecto negativo mayor.

El ATU es ‚àí10.15, que es m√°s peque√±o que el ATE. El efecto del uso del mosquitero es menor para las personas que no est√°n usando los mosquiteros. Nuevamente, esto se debe al sesgo de selecci√≥n. Es probable que aquellos que no usan mosquiteros no lo hagan por razones sistem√°ticas: viven lejos de los mosquitos, han recibido una vacuna contra la malaria, tienen alguna otra forma de control de mosquitos, entre otras cosas. Debido a que podr√≠an tener poco riesgo de exposici√≥n a mosquitos, saben que el uso de mosquiteros no les beneficiar√° mucho, por lo que no buscan mosquiteros. As√≠, si les expandi√©ramos el acceso a los mosquiteros, no se beneficiar√≠an tanto.

Y una nota final sobre el ATE: como vimos antes, incluye tanto al ATT como al ATU. Como es el promedio para todas las personas en toda la poblaci√≥n, es la suma de los promedios ponderados de estos dos estimadores:

$$
\text{ATE} = (\pi_\text{Net users} \times \text{ATT}) + (\pi_\text{Net non-users} \times \text{ATU})
$$

Podemos confirmar esto con los datos:

```{r}
#| label: calc-ate-weighted-sum
effect_types <- nets |> 
  group_by(net) |> 
  summarize(
    effect = mean(ite),
    n = n()
  ) |> 
  mutate(
    prop = n / sum(n),
    weighted_effect = effect * prop
  ) |> 
  mutate(estimand = case_match(net, 0 ~ "ATU", 1 ~ "ATT"), .before = 1)
effect_types

effect_types |> 
  summarize(ATE = sum(weighted_effect))
```

### Encontrar estos estimandos con datos no basados en la m√°quina del tiempo

Hasta ahora hemos calculado el ATE, ATT y ATU con datos basados en una m√°quina del tiempo. Sin embargo, en la vida real, s√≥lo podemos ver esto:

```{r echo =FALSE}
#| label: Tabla_3
#| tbl-cap: " "
#| code-fold: true
#| classes: no-stripe

excerpt |> 
  add_row(id = NA) |> 
  select(
    id, income, health, net, malaria_risk
  ) |> 
  gt() |> 
  sub_missing(missing_text = "‚Ä¶") |>
  fmt_number(
    columns = malaria_risk,
    decimals = 1
  ) |> 
  fmt_number(columns = c(income, health), decimals = 0) |> 
  
  # Column labels
  cols_label(
    id = "ID",
    income = md("$Z_{1_i}$"),
    health = md("$Z_{2_i}$"),
    net = md("$X_i$"),
    malaria_risk = md("$Y_i$")
  ) |>
  
  # Level 1 spanner labels
  tab_spanner(
    label = "Income", columns = income, 
    level = 1, id = "level1_a_obs"
  ) |> 
  tab_spanner(
    label = "Health", columns = health, 
    level = 1, id = "level1_b_obs"
  ) |> 
  tab_spanner(
    label = "Net use", columns = net, 
    level = 1, id = "level1_c_obs"
  ) |> 
  tab_spanner(
    label = "Outcome", columns = malaria_risk, 
    level = 1, id = "level1_d_obs"
  ) |> 
  
  # Level 2 spanner labels
  tab_spanner(
    label = "Confounders",
    columns = c(income, health),
    level = 2, id = "level2_a_obs"
  ) |> 
  tab_spanner(
    label = "Treatment", columns = net, 
    level = 2, id = "level2_b_obs"
  ) |> 
  tab_spanner(
    label = "Realized", columns = malaria_risk, 
    level = 2, id = "level2_c_obs") |> 
  
  # Style stuff
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body()
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_spanners(spanners = starts_with("level1")),
      cells_column_labels(columns = "id")
    )
  ) |> 
  tab_style(
    style = cell_text(style = "italic"),
    locations = cells_column_spanners(spanners = starts_with("level2"))
  ) |> 
  
  tab_style(
    style = list(
      cell_fill(color = clrs[4], alpha = 0.5)
    ),
    locations = cells_body(rows = net == 1)
  ) |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

$\delta_i$ ha desaparecido; ahora solo tenemos $Y_i$. En lugar de comparar y encontrar las diferencias entre individuos y sus versiones paralelas, necesitamos encontrar las diferencias entre personas tratadas y no tratadas mientras eliminamos el sesgo de selecci√≥n y la confusi√≥n causada por ingresos y salud.

En el ejemplo inicial en la Tabla 1, hab√≠a solo un confusor (viejo vs. joven), y lo ajustamos estratificando por edad, combinando los promedios ponderados para personas viejas y j√≥venes. La estratificaci√≥n b√°sica como esa es mucho m√°s dif√≠cil de hacer aqu√≠. Tanto los ingresos como la salud son variables continuas; no podemos simplemente encontrar promedios ponderados de personas ricas vs. pobres y personas enfermas vs. saludables. Tenemos que hacer algo m√°s sofisticado para crear grupos de comparaci√≥n comparables, como el emparejamiento o la ponderaci√≥n.

Es importante destacar que debemos emparejar o ponderar de manera adecuada al estimador que nos importa. El procedimiento de emparejamiento que seguimos para encontrar el ATE no se puede usar para encontrar el ATT; el proceso de ponderaci√≥n que usamos para el ATU es diferente del que usamos para el ATE.

Noah Greifer tiene dos gu√≠as paralelas incre√≠bles para hacer este ajuste, tanto con [ponderaci√≥n {WeightIt}](https://ngreifer.github.io/WeightIt/articles/estimating-effects.html) as√≠ como con [matching {MatchIt}](https://kosukeimai.github.io/MatchIt/articles/estimating-effects.html). En este cap√≠tulo, ilustraremos el ATE, ATT y ATU con ayuda de la ponderaci√≥n considerando puntajes de propensi√≥n (Propensity score weighting o Inverse Probability Weighting - IPW), pero los mismos principios se aplican al matching o emparejamiento (Propensity Score Matching); ¬°y el c√≥digo es casi id√©ntico!)

¬°Cubrir los mecanismos exactos de la ponderaci√≥n de probabilidad inversa va m√°s all√° del alcance de este cap√≠tulo! Pero descuida, los abordaremos m√°s adelante:

En general, con la ponderaci√≥n utilizamos confusores para predecir la probabilidad de elegir el tratamiento (la intervenci√≥n), y luego usamos estos puntajes de propensi√≥n para ponderar nuevamente los grupos tratados y no tratados para que se asemejen entre s√≠, eliminando as√≠ cualquier influencia que los confusores tengan en la asignaci√≥n del tratamiento. Mi modelo mental de la ponderaci√≥n es que creamos pseudo-poblaciones de personas tratadas y no tratadas que se sienten como lo que suceder√≠a si asign√°ramos aleatoriamente a todos a condiciones de tratamiento o control, es como crear grupos de tratamiento y control falsos, pero que en realidad se asemeja al mundo ideal donde aleatorizariamos la intervenci√≥n.

### ATE

Para encontrar el ATE, necesitamos ajustar tanto a los grupos tratados como a los no tratados para que sean comparables. La forma m√°s com√∫n de hacer esto es crear pesos de probabilidad inversa, donde todas las personas tratadas obtienen un peso de $\frac{1}{p_i}$ y todas las personas no tratadas obtienen un peso de $\frac{1}{1 - p_i}$ (donde $p_i$ se refiere a los puntajes de propensi√≥n de cada persona).

Hablando pr√°cticamente, esto da m√°s peso a las observaciones m√°s inusuales e inesperadas. Por ejemplo, alguien con una alta probabilidad predicha (90%) de elegir usar un mosquitero que luego lo usa no es realmente notable y tendr√° un peso bajo ($\frac{1}{0.9}$, o 1.111). Alguien m√°s con una alta probabilidad (90% nuevamente) de elegir un mosquitero que no lo usa tendr√° un peso alto ($\frac{1}{1 - 0.9}$, o 10). Esto hace que la persona que deber√≠a haber usado un mosquitero sea m√°s comparable a las personas no tratadas correspondientes.

¬°La visualizaci√≥n ayuda mucho con esta intuici√≥n!

Primero, usaremos regresi√≥n log√≠stica para calcular las [*probabilidades predichas de usar un mosquitero (esto es el puntaje de propensi√≥n)*]{.underline}.

::: callout-warning
## ¬øA√∫n no dominas el lenguaje de R?

No te preocupes. Utilizamos la estad√≠stica para demostrar que todo lo que explicamos puede calcularse, y eso significa que en el futuro ser√°s capaz de hacer tus propias estimaciones.

Si el c√≥digo te resulta complicado por ahora, no te preocupes por entender cada detalle. En los pr√≥ximos cap√≠tulos aprender√°s y dominar√°s todo lo esencial de este lenguaje.
:::

```{r}
# Logistic regression model to predict net usage
model_treatment <- glm(
  net ~ income + health, 
  data = nets, 
  family = binomial(link = "logit")
)

```

Luego, crearemos pesos de probabilidad inversa con esta f√≥rmula, que utiliza el hecho de que recibir mosquitero se codifica como 1 y no recibirlo como 0, para asignar el peso correcto de tratado vs. no tratado:

$$
\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
$$

Nota que si no recibe tratamiento (valor = 0) el primer componente se elimina y qedar√≠a:

$$
Weight = \frac{1}{1 - \text{Propensity}}
$$

Y si recibe el tratamiento (valor = 1) el peso quedar√≠a: $$
Weight = \frac{1}{\text{Propensity}}
$$

```{r}
#| label: calc-wts-net-ate-manual

# Plug original data into the model to generate predicted probabilities
#
# (Here I'm using broom::augment_columns(), but you can also use 
#  marginaleffects::predictions() or even base R's predict())
# 
# Create a new column for the weights
nets_with_weights <- augment_columns(
  model_treatment,
  data = nets,
  type.predict = "response"
) |> 
  rename(propensity = .fitted) |> 
  mutate(wts_ate = (net / propensity) + ((1 - net) / (1 - propensity)))

# See if it worked
ver_ATE <-nets_with_weights |> 
  select(id, income, health, net, malaria_risk, propensity, wts_ate)
```

```{r echo=FALSE}
DT::datatable(ver_ATE,  options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )

```

Alternativamente, podemos utilizar el paquete {WeightIt} para hacer lo mismo:

```{r}
#| label: calc-wts-net-ate

# Get ATE-focused weights for the treatment model
weights_ate <- weightit(
  net ~ income + health, 
  data = nets, 
  method = "glm", 
  estimand = "ATE"
)

# Add the weights as a column in the data
nets_with_weights$wts_ate_automatic <- weights_ate$weights

# They're the same!
ver_ATE <- nets_with_weights |> 
  select(id, wts_ate, wts_ate_automatic) |> 
  head()
```

```{r echo=FALSE}
DT::datatable(ver_ATE,  options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )

```

Veamos de forma gr√°fica como se ve la distribuci√≥n de las probabilidades de usar o no mosquiteros (los puntajes de propensi√≥n).

```{r echo=FALSE}
#| label: fig-propensity-treated-untreated
#| fig-cap: "Mirrored histogram showing the distribution of propensity scores for treated and untreated people"
#| fig-width: 6
#| fig-height: 3.75
#| code-fold: true

plot_data_weights_ate <- tibble(
  propensity = weights_ate$ps,
  weight = weights_ate$weights,
  treatment = weights_ate$treat
)

ggplot() + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 1), 
    bins = 50, aes(x = propensity, fill = "Treated people")) + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 0), 
    bins = 50, aes(x = propensity, y = -after_stat(count), fill = "Untreated people")) +
  geom_hline(yintercept = 0, color = "white", linewidth = 0.25) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(label = abs) +
  scale_fill_manual(values = c(clrs[1], clrs[6]), guide = guide_legend(reverse = TRUE)) +
  labs(x = "Propensity", y = "Count", fill = NULL) +
  theme(
    legend.position = "top",
    legend.key.size = unit(0.65, "lines")
  )
```

En general, las personas que utilizaban mosquiteros ten√≠an una mayor probabilidad de utilizarlas, mientras que las personas que no las utilizaban ten√≠an una menor probabilidad de utilizarlas. Era de esperar.

Pero hay algunas personas que ten√≠an una probabilidad baja de usar redes que *las usaron*, y algunas personas que ten√≠an una probabilidad alta de usar redes que *no las usaron*. Es curioso y extra√±o. Podr√≠a decirse que estas personas son muy parecidas (es decir, con ingresos y salud similares), pero, por la raz√≥n que sea, no hicieron lo que el modelo predec√≠a que deb√≠an hacer.

```{r , echo=FALSE}
#| label: fig-propensity-weird-highlight
#| fig-cap: 'Mirrored histogram showing "weird" parts of the population: treated people who were unlikely to be treated, and untreated people who were likely to be treated'
#| fig-width: 6
#| fig-height: 3.75
#| code-fold: true

ggplot() + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 1), 
    bins = 50, aes(x = propensity, fill = "Treated people")) + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 0), 
    bins = 50, aes(x = propensity, y = -after_stat(count), fill = "Untreated people")) +
  annotate(
    geom = "rect", xmin = 0, xmax = 0.55, ymin = -1, ymax = 23,
    fill = alpha(clrs[4], 0.1), color = clrs[4], linewidth = 1
  ) +
  annotate(
    geom = "text", x = 0.01, y = 21.5, 
    label = "Treated people who were\nunlikely to be treated.\nWeird!",
    color = clrs[3], fontface = "bold", hjust = 0, vjust = 1, lineheight = 1
  ) +
  annotate(
    geom = "rect", xmin = 0.58, xmax = 1, ymin = 1, ymax = -27.5,
    fill = alpha(clrs[4], 0.1), color = clrs[4], linewidth = 1
  ) +
  annotate(
    geom = "text", x = 0.99, y = -26, 
    label = "Weird!\nUntreated people who\nwere likely to be treated.",
    color = clrs[3], fontface = "bold", hjust = 1, vjust = 0, lineheight = 1
  ) +
  geom_hline(yintercept = 0, color = "white", linewidth = 0.25) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(label = abs) +
  scale_fill_manual(values = c(clrs[1], clrs[6]), guide = guide_legend(reverse = TRUE)) +
  labs(x = "Propensity", y = "Count", fill = NULL) +
  theme(
    legend.position = "top",
    legend.key.size = unit(0.65, "lines")
  )
```

Si escalamos la importancia de cada uno seg√∫n su peso probabil√≠stico inverso, podemos dar m√°s importancia a estas personas "raras" no tratadas-pero-deber√≠an-haber-sido-tratadas y tratadas-pero-no-deber√≠an-haber-sido-tratadas, haci√©ndolas m√°s equilibradas en comparaci√≥n con sus hom√≥logos tratados-y-deber√≠an-haber-sido-tratados y no tratados-y-deber√≠an-haber-sido-no-tratados. El histograma m√°s tenue representa las pseudopoblaciones ajustadas y reponderadas de usuarios y no usuarios de la red. Estas dos pseudopoblaciones est√°n ahora libres de los factores de confusi√≥n derivados de la salud y los ingresos, y se podr√≠a decir que son m√°s comparables, actuando m√°s como grupos aleatorios de tratamiento y control.

```{r , echo=FALSE}
#| label: fig-propensity-weighted-ate
#| fig-cap: "Mirrored histogram showing pseudo-populations of treated and untreated people that have been reweighted to be more comparable and unconfounded"
#| fig-width: 6
#| fig-height: 4.5
#| code-fold: true

ggplot() + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 1), 
    bins = 50, aes(x = propensity, weight = weight, fill = "Treated pseudo-population")) + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 0), 
    bins = 50, aes(x = propensity, weight = weight, y = -after_stat(count), fill = "Untreated psuedo-population")) +
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 1), 
    bins = 50, aes(x = propensity, fill = "Treated people")) + 
  geom_histogram(data = filter(plot_data_weights_ate, treatment == 0), 
    bins = 50, aes(x = propensity, y = -after_stat(count), fill = "Untreated people")) +
  annotate(
    geom = "text", x = 0.5, y = 60, label = "More weight here", 
    hjust = 0.5, fontface = "bold", color = clrs[3]
  ) +
  annotate(
    geom = "segment", x = 0.48, xend = 0.17, y = 55, yend = 25, color = "white", 
    arrow = arrow(angle = 15, length = unit(0.5, "lines")), linewidth = 2.5
  ) +
  annotate(
    geom = "segment", x = 0.48, xend = 0.17, y = 55, yend = 25, color = clrs[3], 
    arrow = arrow(angle = 15, length = unit(0.5, "lines")), linewidth = 0.5
  ) +
  annotate(
    geom = "segment", x = 0.52, xend = 0.8, y = 55, yend = -20, color = "white", 
    arrow = arrow(angle = 15, length = unit(0.5, "lines")), linewidth = 2.5
  ) +
  annotate(
    geom = "segment", x = 0.52, xend = 0.8, y = 55, yend = -20, color = clrs[3], 
    arrow = arrow(angle = 15, length = unit(0.5, "lines")), linewidth = 0.5
  ) +
  geom_hline(yintercept = 0, color = "white", linewidth = 0.25) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(label = abs) +
  scale_fill_manual(
    values = c(clrs[1], colorspace::lighten(clrs[1], 0.5), clrs[6], colorspace::lighten(clrs[6], 0.65)), 
    guide = guide_legend(reverse = FALSE, nrow = 2)) +
  labs(x = "Propensity", y = "Count", fill = NULL) +
  theme(
    legend.position = "top",
    legend.key.size = unit(0.65, "lines")
  )
```

Para encontrar el ATE usando estos pesos, podemos ajustar un modelo de regresi√≥n para el desenlace. Luego, utilizaremos un enfoque llamado g-computation para encontrar el efecto causal marginal (es decir, el efecto causal de cambiar el mosquitero de "no" a "s√≠"). La g-computation es un enfoque ingenioso que se siente m√°s como el marco de resultados potenciales original que examinamos anteriormente. Involucra algunos pasos:

1.  Ajustar un modelo de regresi√≥n ponderada por el puntaje de propensi√≥n que prediga el resultado, como lm(riesgo_malaria \~ mosquitero, weights = w_ate, ...).

2.  Utilizar el modelo para generar un conjunto de predicciones donde fingimos que cada persona us√≥ un mosquitero (es decir, establecemos mosquitero = 1, para todos).

3.  Utilizar el modelo para generar un conjunto de predicciones donde fingimos que cada persona no us√≥ un mosquitero (es decir, establecemos mosquitero = 0, para todos).

4.  Calcular la diferencia entre los dos conjuntos de predicciones para crear una especie de efecto causal individual (ITE) predicho, luego encontrar el promedio de eso. Ese es el ATE.

Eso parece realmente complicado y extenso y parece mucho trabajo de codificaci√≥n, pero {marignaleffects} hace esto incre√≠blemente f√°cil. B√°sicamente, todo lo que tenemos que hacer es usar avg_comparisons(modelo_resultado, variables = list(mosquitero = 0:1)), o incluso m√°s simplemente avg_comparisons(modelo_resultado, variables = "mosquitero"). Esto har√° todo el trabajo de establecer el tratamiento de todos en 0 y 1, y encontrar la diferencia. Tambi√©n podemos hacer cosas m√°s sofisticadas con √©l, como encontrar errores est√°ndar robustos y/o agrupados, o hacer bootstraping para calcular los errores est√°ndar.

```{r}
#| label: calc-net-ate
# Fit an outcome model using the inverse probability weights
model_outcome_ate <- lm(
  malaria_risk ~ net, 
  data = nets_with_weights, 
  weights = wts_ate_automatic
)

# Automatic g-computation with {marginaleffects}! This sets the "net" column to
# each possible value of net (0 and 1) for the whole dataset, then calculates
# the difference between the two sets of predictions
avg_comparisons(model_outcome_ate, variables = "net") 
```

```{r}
#| label: calc-ate-hidden
#| include: false

estimated_ate <- avg_comparisons(model_outcome_ate, variables = "net") |> 
  pull(estimate)

estimated_ate
```

Bas√°ndonos en nuestro enfoque de ponderaci√≥n de probabilidad inversa, el ATE de los datos observacionales (es decir, sin utilizar los resultados potenciales individuales desconocidos) es `-14.7`, ¬°que est√° muy cerca del verdadero ATE de `-15.0`!

### ATT

Esta ATE muestra el efecto del programa de mosquiteros para *todos*, incluso para las personas que no necesitan mosquiteros. Si estamos interesados en hacer de este un programa universal, el ATE es √∫til. Si lo que nos interesa es saber qu√© efecto tiene el programa en las personas que lo utilizan, o qu√© pasar√≠a si lo ampli√°ramos a las personas que no lo utilizan, tendr√≠amos que encontrar el ATT o el ATU.

Podemos hacer esto con emparejamiento y ponderaci√≥n, pero *no podemos utilizar el mismo emparejamiento y ponderaci√≥n que utilizamos para encontrar la ATE.* Al reponderar los datos para estimar la ATT, no debemos hacer nada que altere las ponderaciones del grupo tratado. Dado que estamos interesados en el efecto del programa s√≥lo en las personas tratadas, necesitamos crear un pseudogrupo de control que se parezca al grupo tratado. Hay muchas formas diferentes de hacerlo. Revisar a [Greifer and Stuart](https://doi.org/10.48550/arXiv.2106.10577) para m√°s detalles. Una forma com√∫n es dar un peso de 1 a todas las personas tratadas y un peso de $\frac{p_i}{1 - p_i}$ para todas las personas no tratadas.

El proceso es el mismo: ajustar un modelo que prediga si las personas utilizan una red, utilizar esas predicciones para generar ponderaciones y, a continuaci√≥n, ajustar un modelo de resultados utilizando esas ponderaciones. Con las ponderaciones espec√≠ficas de ATT, crearemos una pseudopoblaci√≥n no tratada que es estad√≠sticamente comparable (e infundada) en relaci√≥n con la poblaci√≥n realmente tratada.

```{r }
#| label: calc-wts-net-att
# Get ATT-focused weights for the treatment model
weights_att <- weightit(
  net ~ income + health, 
  data = nets, 
  method = "glm", 
  estimand = "ATT"
)

# Add the weights as a column in the data
nets_with_weights$wts_att <- weights_att$weights

ver_ATT <- nets_with_weights %>% select(id , net , "wts_ate", "wts_att" )

```

```{r, echo=FALSE}

DT::datatable(ver_ATT ,  options = list(pageLength = 5, scrollX=T), class = 'white-space: nowrap' )
```

Nuestro elegante histograma ponderado tiene este aspecto:

```{r, echo=FALSE}
#| label: fig-propensity-weighted-att
#| fig-cap: "Mirrored histogram comparing the distribution of treated people with the reweighted pseudo-population of untreated people; because this is for the ATT, treated people were not reweighted"
#| fig-width: 6
#| fig-height: 3.75
#| code-fold: true

plot_data_weights_att <- tibble(
  propensity = weights_att$ps,
  weight = weights_att$weights,
  treatment = weights_att$treat
)

ggplot() + 
  geom_histogram(data = filter(plot_data_weights_att, treatment == 0), 
    bins = 50, aes(x = propensity, weight = weight, y = -after_stat(count), fill = "Untreated psuedo-population")) +
  geom_histogram(data = filter(plot_data_weights_att, treatment == 1), 
    bins = 50, aes(x = propensity, fill = "Treated people")) + 
  geom_histogram(data = filter(plot_data_weights_att, treatment == 0), 
    bins = 50, alpha = 0.5, 
    aes(x = propensity, y = -after_stat(count), fill = "Untreated people")) +
  geom_hline(yintercept = 0, color = "white", linewidth = 0.25) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(label = abs) +
  scale_fill_manual(
    values = c(clrs[1], "grey50", colorspace::lighten(clrs[6], 0.65)), 
    guide = guide_legend(reverse = FALSE, nrow = 2)) +
  labs(x = "Propensity", y = "Count", fill = NULL) +
  theme(
    legend.position = "top",
    legend.key.size = unit(0.65, "lines")
  )
```

Las personas tratadas no se tocan: todas tienen un peso de 1 y no nos metemos con ellas. A las personas no tratadas con alta probabilidad de utilizar una red se les da m√°s peso para que se parezcan m√°s a las personas tratadas.

Ajustar el modelo de resultados es lo mismo que hallar el ATE, s√≥lo que utilizaremos las ponderaciones especiales de ATT:

```{r}
#| label: calc-outcome-att
# Fit an outcome model using the ATT weights
model_outcome_att <- lm(
  malaria_risk ~ net, 
  data = nets_with_weights, 
  weights = wts_att
)
```

La principal diferencia es que cuando hacemos el c√°lculo g, *s√≥lo nos fijamos en las personas tratadas*. Usando solo esta parte de la poblaci√≥n, pondremos todos sus valores a 1, luego pondremos todos sus valores a 0, y luego encontraremos la diferencia.

\*\*Esta es la clave para encontrar el efecto del programa s√≥lo en la parte tratada de la poblaci√≥n ¬øRecuerda c√≥mo cuando ten√≠amos acceso a los efectos causales individuales de cada uno, pudimos encontrar el ATT mirando la media de la columna $\delta$ de todas las personas tratadas? G-computation nos permite esencialmente recrear ese proceso. As√≠ es como funciona:

```{r}
#| label: calc-comparisons-att
# Do g-computation *only* on treated observations
avg_comparisons(
  model_outcome_att, 
  variables = "net", 
  newdata = filter(nets, net == 1)
)
```

```{r}
#| label: calc-att-hidden
#| include: false

estimated_att <- avg_comparisons(
  model_outcome_att, 
  variables = "net", 
  newdata = filter(nets, net == 1)
) |> 
  pull(estimate)

estimated_att
```

El ATT observacional estimada es `-17.6`, que es (1) mayor que la ATE, como se esperaba, y (2) ¬°m√°s o menos cercana a la verdadera ATT de `-16.3`!

### ATU

Si nos interesa saber qu√© pasar√≠a si ampli√°ramos el programa a personas que no lo utilizan, podemos encontrar la ATU El proceso es el mismo que para la ATT, pero a la inversa. Vamos a crear una pseudo-poblaci√≥n de usuarios netos dando un peso de 1 a todas las personas no tratadas y dando un peso de $\frac{1-p_i}{p_i}$ a todas las personas tratadas.

```{r}
#| label: calc-wts-net-atu
# Get ATU-focused weights for the treatment model
weights_atu <- weightit(
  net ~ income + health, 
  data = nets, 
  method = "glm", 
  estimand = "ATC"  # WeightIt calls this ATC instead of ATU
)

# Add the weights as a column in the data
nets_with_weights$wts_atu <- weights_atu$weights
```

Esto es lo que parece un histograma ponderado:

```{r, echo =FALSE}
#| label: fig-propensity-weighted-atu
#| fig-cap: "Mirrored histogram comparing the distribution of untreated people with the reweighted pseudo-population of treated people; because this is for the ATU, untreated people were not reweighted"
#| fig-width: 6
#| fig-height: 3.75
#| code-fold: true

plot_data_weights_atu <- tibble(
  propensity = weights_atu$ps,
  weight = weights_atu$weights,
  treatment = weights_atu$treat
)

ggplot() + 
  geom_histogram(data = filter(plot_data_weights_atu, treatment == 1), 
    bins = 50, aes(x = propensity, weight = weight, fill = "Treated pseudo-population")) + 
  geom_histogram(data = filter(plot_data_weights_atu, treatment == 1), 
    bins = 50, alpha = 0.5, aes(x = propensity, fill = "Treated people")) + 
  geom_histogram(data = filter(plot_data_weights_atu, treatment == 0), 
    bins = 50, aes(x = propensity, y = -after_stat(count), fill = "Untreated people")) +
  geom_hline(yintercept = 0, color = "white", linewidth = 0.25) +
  scale_x_continuous(labels = scales::label_percent()) +
  scale_y_continuous(label = abs) +
  scale_fill_manual(
    values = c("grey50", colorspace::lighten(clrs[1], 0.5), clrs[6], colorspace::lighten(clrs[6], 0.65)), 
    guide = guide_legend(reverse = FALSE, nrow = 2)) +
  labs(x = "Propensity", y = "Count", fill = NULL) +
  theme(
    legend.position = "top",
    legend.key.size = unit(0.65, "lines")
  )
```

Los usuarios de mosquieteros de baja probabilidad reciben mucha m√°s ponderaci√≥n para que sean comparables al grupo no tratado.

El proceso del modelo de resultados es el mismo que antes: s√≥lo utilizamos las ponderaciones espec√≠ficas de la ATU Al realizar el c√°lculo de g, *s√≥lo utilizamos a las personas no tratadas*.

```{r}
#| label: calc-net-atu
# Fit an outcome model using the ATU weights
model_outcome_atu <- lm(
  malaria_risk ~ net, 
  data = nets_with_weights, 
  weights = wts_atu
)

# Do g-computation *only* on untreated observations
avg_comparisons(
  model_outcome_atu, 
  variables = "net", 
  newdata = filter(nets, net == 0)
)
```

```{r}
#| label: calc-atu-hidden
#| include: false

estimated_atu <- avg_comparisons(
  model_outcome_atu, 
  variables = "net", 
  newdata = filter(nets, net == 0)
) |> 
  pull(estimate)

estimated_atu
```

EL ATU observacional estimado es de `-11.7`, que es (1) menor que la ATE, como se esperaba, y (2) ¬°m√°s o menos cercana al verdadero ATU de `-13.6`!

### Interpretaci√≥n

Por √∫ltimo, vamos a mostrar estos estimandos todos juntos, con alguna interpretaci√≥n b√°sica de lo que significan todos ellos:

```{r}
#| label: tbl-summary
#| tbl-cap: "Summary of the three main estimands"
#| echo: false

interpretation_ate <- glue::glue(
  "Usar un mosquitero reduce el riesgo de malaria en {nice_number(abs(estimated_ate))} puntos, en promedio en toda la poblaci√≥n del pa√≠s"
)
why_ate <- "√ötil para entender el efecto de crear una pol√≠tica o programa ampliamente aplicado, como la distribuci√≥n de mosquiteros subsidiados para todos en el pa√≠s"

interpretation_att <- glue::glue(
  "Las personas que actualmente usan mosquiteros ven una reducci√≥n del riesgo de malaria de {nice_number(abs(estimated_att))} puntos, en promedio"
)
why_att <- "√ötil para entender el efecto del uso de mosquiteros en las personas que realmente los utilizan; esto muestra lo que suceder√≠a si retir√°ramos el programa o quit√°ramos los mosquiteros a todos"

interpretation_atu <- glue::glue(
  "Las personas que actualmente no usan mosquiteros ver√≠an una reducci√≥n del riesgo de malaria de {nice_number(abs(estimated_atu))} puntos, en promedio"
)
why_atu <- "√ötil para entender el efecto del uso de mosquiteros en las personas que no los utilizan actualmente; esto muestra lo que suceder√≠a si expandi√©ramos el programa o di√©ramos mosquiteros a personas que no los tienen"

tribble(
  ~estimand, ~true_value, ~estimated_value, ~interpretation,    ~why,
  "ATE",     true_ate,    estimated_ate,    interpretation_ate, why_ate,
  "ATT",     true_att,    estimated_att,    interpretation_att, why_att,
  "ATU",     true_atu,    estimated_atu,    interpretation_atu, why_atu
) |> 
  gt() |> 
  cols_label(
    estimand = "Estimand",
    true_value = "True value",
    estimated_value = "Estimated value",
    interpretation = "Interpretation",
    why = "Why care?"
  ) |> 
  cols_align(
    align = "left",
    columns = c(estimand, interpretation, why)
  ) |> 
  cols_align(
    align = "center",
    columns = c(true_value, estimated_value)
  ) |> 
  fmt_number(
    columns = c(true_value, estimated_value),
    decimals = 1
  ) |> 
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) |> 
  tab_style(
    style = cell_text(v_align = "top"),
    locations = cells_body()
  ) |> 
  tab_source_note(source_note = "Here, the fact that ATT > ATE > ATU implies selection bias; the program works more effectively among those who use it because they know it will help them") |> 
  opt_horizontal_padding(scale = 3) |> 
  opt_table_font(font = "Jost")
```

## ¬øQu√© otros m√©todos existen?

¬°Es genial saber que est√°s encontrando claridad al entender los m√©todos de inferencia causal! De hecho, el Efecto Medio del Tratamiento (ATE) no es el √∫nico estimador de inter√©s, y a veces el Efecto Medio del Tratamiento en los Tratados (ATT) puede ser m√°s relevante para las decisiones de pol√≠tica. El ATT se centra espec√≠ficamente en el efecto del tratamiento para aquellos que realmente lo reciben, brindando informaci√≥n valiosa para intervenciones dirigidas.

M√©todos como el de diferencias en diferencias (diff-in-diff) com√∫nmente utilizados en econometr√≠a y ciencias sociales estiman el ATT en lugar del ATE. Este enfoque eval√∫a el impacto de una intervenci√≥n √∫nicamente en el grupo tratado, sin depender de un grupo de control. Curiosamente, a pesar de su amplio uso, el diff-in-diff no produce un ATE a nivel de poblaci√≥n.

Otras t√©cnicas cuasi experimentales, como la regresi√≥n discontinua y las variables instrumentales, ofrecen efectos causales m√°s restringidos. T√≠picamente, estiman el Efecto Medio del Tratamiento Local (LATE), que se refiere a un segmento m√°s estrecho de la poblaci√≥n. Por ejemplo, la regresi√≥n discontinua identifica el ATE para individuos cerca de un umbral predefinido que afecta la asignaci√≥n de tratamiento, mientras que las variables instrumentales estiman el ATE para aquellos que cumplen con la asignaci√≥n del programa. Estos m√©todos proporcionan informaci√≥n valiosa sobre efectos causales, pero dentro de subconjuntos espec√≠ficos de la poblaci√≥n.

# Referencias

-   Ross, R.D., Shi, X., Caram, M.E.V. et al. Veridical causal inference using propensity score methods for comparative effectiveness research with medical claims. Health Serv Outcomes Res Method (2020). <https://doi.org/10.1007/s10742-020-00222-8>

-   Elwert, F. (2013). Graphical Causal Models. In S. L. Morgan (Ed.), *Handbook of Causal Analysis for Social Research* (pp. 245--273). Springer.

-   Hern√°n, M. A., & Robbins, J. M. (2020). *Causal Inference: What If*. CRC Press.

-   Morgan, S. L., & Winship, C. (2007). *Counterfactuals and Causal Inference: Methods and Principles for Social Research*. Cambridge University Press.

-   Pearl, J., Glymour, M., & Jewell, N. P. (2016). *Causal Inference in Statistics: A Primer*. Wiley.

-   Pearl, J., & Mackenzie, D. (2018). *The Book of Why: The New Science of Cause and Effect*. Basic Books.

-   Rohrer, J. M. (2018). Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data. *Advances in Methods and Practices in Psychological Science*, *1*(1), 27--42.

-   Shalizi, C. R. (2019). *Advanced Data Analysis From an Elementary Point of view*. <https://www.stat.cmu.edu/~cshalizi/ADAfaEPoV/ADAfaEPoV.pdf>
